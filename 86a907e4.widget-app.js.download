"use strict";angular.module("soWidget",["ui.router","ui.bootstrap","pascalprecht.translate","angular-ladda","soCore"]),function(){angular.module("soWidget").config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:"/translations/settings_",suffix:".json"}),a.preferredLanguage("en").fallbackLanguage("en")}]).config(["$httpProvider",function(a){a.interceptors.push("RequestInterceptor")}]).config(["laddaProvider",function(a){a.setOption({style:"expand-right"})}])}(),function(){angular.module("soWidget").config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b,c){b.otherwise("/"),c.html5Mode(!1),a.state("widget",{"abstract":!0,views:{index:{templateUrl:"views/widget.html",controller:"LayoutCtrl",controllerAs:"layoutVM"}},resolve:{savedSettings:["$q","SettingsService",function(a,b){var c=a.defer();return b.get().then(function(a){c.resolve(a)},function(a){c.reject(a)}),c.promise}]}}).state("widget.layout",{url:"/",views:{"feed@widget":{templateUrl:"views/widget.feed.html",controller:"FeedCtrl",controllerAs:"feedVM"},"subscription@widget":{templateUrl:"views/widget.subscription.html"}}})}])}(),function(){angular.module("soWidget").run(["$rootScope","$translate","WixService",function(a,b,c){function d(){var a=navigator.userAgent.toLowerCase();return-1!==a.indexOf("msie")?parseInt(a.split("msie")[1]):navigator.userAgent.match(/Trident.*rv[ :]*11\./)?11:!1}a.isFirefox="undefined"!=typeof InstallTrigger,a.isIE=d(),a.deviceType="desktop";try{a.deviceType=Wix.Utils.getDeviceType().toLowerCase()}catch(e){}try{b.use(c.getLocale())}catch(e){b.use("en")}}])}(),function(){function a(a,b,c,d){function e(e,f){var g=b.defer();return d.getUserSession().then(function(b){a({method:"POST",url:c.url+"/contacts",data:{token:b||"NO_SV",emailAddress:e,confirmation:f}}).then(function(a){g.resolve(a.data)},function(a){g.reject(a)})}),g.promise}return{create:e}}angular.module("soWidget").factory("ContactsService",["$http","$q","RESTApi","WixService",a])}(),function(){function a(a,b,c,d,e,f){function g(){Wix.addEventListener(Wix.Events.SETTINGS_UPDATED,function(b){l.settingsModel=b.data,k(),b.needReset&&a.$broadcast(d.resetShoutouts,{applyResize:!1}),a.$apply(),i()})}function h(){Wix.addEventListener(Wix.Events.STYLE_PARAMS_CHANGE,function(){i()})}function i(){a.$emit(d.applyResize)}function j(){"editor"===Wix.Utils.getViewMode().toLowerCase()&&(g(),h()),k()}function k(){try{if(l.settingsModel.userLanguage)l.settingsModel.userLanguage.index?e.use(l.settingsModel.userLanguage.value.toLowerCase()):l.settingsModel.userDefaultLanguage&&e.use(l.settingsModel.userDefaultLanguage.toLowerCase());else{var a=f.getLocale();l.settingsModel.userLanguage={value:a.charAt(0).toUpperCase()+a.substr(1)},e.use(c.userLanguage.value)}}catch(b){e.use("en")}}var l=this;l.settingsModel=b.unflatten(c),l.wixStyles=Wix.Styles.getStyleParams(),l.headerAlign=["align_left","align_center","align_right"],l.viewMode=Wix.Utils.getViewMode(),a.getDisplayMode=function(){return l.settingsModel.settings.display.state},a.getMyMostRecentCount=function(){return l.settingsModel.settings.display.myLast},j()}angular.module("soWidget").controller("LayoutCtrl",["$scope","JsonService","savedSettings","EVENTS","$translate","WixService",a])}(),function(){function a(a,b,c,d){function e(){return 1!==a.getDisplayMode()?null:a.getMyMostRecentCount()}function f(){b(function(){a.$emit(d.applyResize)},1)}function g(a){function b(){a=a||{},a.resetPaging=a.resetPaging||!1,a.applyResize=a.applyResize||!1,a.count=a.count||null}function d(b){k.shoutOuts=k.shoutOuts.concat(b),a.applyResize&&f()}function e(){k.shoutOuts&&k.shoutOuts.length||(k.shoutOuts=null),f()}function g(){k.config.fetchingData=!1,k.config.reloading=!1}b(a),c.get({resetPaging:a.resetPaging,count:a.count}).then(d,e).then(g)}function h(){a.$on(d.resetShoutouts,function(a,b){k.shoutOuts=[],k.config.fetchingData=!0;var c={resetPaging:!0,applyResize:b.applyResize||!0};c.count=e(),g(c)})}function i(){k.config.fetchingData=!0,$("#shoutOutList").bind("scroll",function(){if($("#shoutOutList").scrollTop()+$("#shoutOutList").innerHeight()>=$("#shoutOutList")[0].scrollHeight){if(k.config.reloading=!0,1===a.getDisplayMode())return;g({resetPaging:!1,applyResize:!1})}})}function j(){f(),i(),h()}var k=this;k.shoutOuts=[],k.config={shoutOutCharLimit:40,fetchingData:!0,reloading:!0},j()}angular.module("soWidget").controller("FeedCtrl",["$scope","$timeout","ShoutOutService","EVENTS",a])}(),function(){function a(a,b,c,d){function e(e,f,g){function h(){var a=document.getElementById("subscription_popup");a.style.height=document.getElementById("subscriptionForm").clientHeight+"px",a.style.display="table",a.classList.add("inactive"),a.classList.add("active"),a.classList.remove("inactive")}function i(){var a=document.getElementById("subscription_popup");a.style.display="none",a.classList.add("inactive"),a.classList.remove("active"),b(function(){e.config.submitInProgress=!1},100)}function j(){h(),e.subscriptionForm.$setPristine(),e.input.userEmailAddress=""}function k(){e.config.subscriptionFailure=!0,h()}function l(a,b){var c="id"===b?"#":".";$(c+a).focus()}function m(){b(function(){e.$emit(d.applyResize)},5)}e.input={},e.config={},e.input.userEmailAddress="",e.config.subscriptionFailure=!1,e.config.submitLoading=!1,e.config.submitInProgress=!1,e.config.invalidEmail=!1,e.$watch("config.invalidEmail",function(a){var b=$(".email_error");switch(a){case!0:b.addClass("show");break;case!1:b.removeClass("show")}}),e.onUserInput=function(){e.config.invalidEmail&&(e.config.invalidEmail=!1,m())},e.subscribe=function(d){function f(){a.cancel(h),e.config.submitLoading=1,b(function(){e.config.submitLoading=!1},500)}if(l("submitBtn","id"),!e.config.submitInProgress){if(!/^[a-zA-Z0-9_\-+.]+@[a-zA-Z0-9_\-+]+\.[a-zA-Z0-9_\-+.]+$/.test(e.input.userEmailAddress))return e.config.invalidEmail=!0,void m();e.config.invalidEmail=!1,e.config.submitInProgress=!0,e.config.subscriptionFailure=!1,e.config.submitLoading=.1;var h=a(function(){e.config.submitLoading<.9&&(e.config.submitLoading=e.config.submitLoading+=.025)},150,30);c.create(d,g.confirmation).then(j,k).then(f).then(m)}},e.closePopup=function(){i()}}return{restrict:"E",replace:!0,templateUrl:"directives/soSubscriptionForm.tpl.html",link:e}}angular.module("soWidget").directive("soSubscriptionForm",["$interval","$timeout","ContactsService","EVENTS",a])}(),function(){function a(){function a(a,b,c,d){a.imgSuffix="_srz_160_160_75_22_0.5_1.20_0.00_.jpg_srz",a.so=JSON.parse(c.soData),null!==a.so.snippets.image&&(a.so.snippets.image+=a.imgSuffix),d.so=a.so,d.setModel(a.so)}function b(a,b,c){this.so={},this.setModel=function(a){this.so=a},this.setSoSnippet=function(a){this.so.snippets&&(this.so.snippets.image=a)}}return{restrict:"E",templateUrl:"directives/shoutOut.tpl.html",link:a,controller:[b]}}angular.module("soWidget").directive("shoutOut",[a])}(),function(){function a(a,b,c,d){function e(e,f,g){function h(){var a=$("#header").height(),f=$("#subscriptionForm").height(),h=2*Math.ceil(g.soResize)+1,i=e.windowHeight-(a+f+h+3)+"px";c(function(){$("#shoutOutList").css("height",i),$("#noShoutOuts").css("height",i),$("#spinner").css("height",i)},5),b.$broadcast(d.resizeFinish),m!==e.windowHeight&&b.$broadcast(d.resetShoutouts,{applyResize:!1}),m=e.windowHeight}function i(){var a=_.debounce(function(){e.$apply()},250);l.bind("resize",a)}function j(){b.$on(d.applyResize,function(){h()})}function k(){i(),j()}var l=angular.element(a),m="";e.getWindowDimensions=function(){return{h:l.height(),w:l.width()}},e.$watch(e.getWindowDimensions,function(a){e.windowHeight=a.h,e.windowWidth=a.w,h()},!0),k()}return{link:e}}angular.module("soWidget").directive("soResize",["$window","$rootScope","$timeout","EVENTS",a])}(),function(){function a(a,b){function c(c,d,e){function f(){var a=$("#shoutoutContainer").width(),b=g();c.feedVM.config.shoutOutCharLimit=h(b,a-j-l)}function g(){var a=document.createElement("canvas");return a.getContext("2d")}function h(a,b){function c(a,b){for(var c="W",d="W";a.measureText(d).width<=b;)d+=c;return d}return Math.ceil(c(a,b).length*k)}function i(){a.$on(b.resizeFinish,f)}var j=65,k=3,l=20;i()}return{restrict:"A",link:c}}angular.module("soWidget").directive("soCharLimit",["$rootScope","EVENTS",a])}(),function(){function a(a){return{link:function(b,c,d,e){function f(b){e.setSoSnippet(b),a.$apply()}function g(){c.unbind("error")}var h="_srz_160_160_75_22_0.5_1.20_0.00_.jpg_srz";c.bind("error",function(a){if(a.target.currentSrc.indexOf(h)>-1){var b=a.target.currentSrc.substr(0,a.target.currentSrc.indexOf(h));f(b)}else f(null),g()})},require:"^shoutOut"}}angular.module("soWidget").directive("soOnError",["$rootScope",a])}(),function(){function a(){return function(a){var b=a/1e6;return moment(b).format("MMM D")}}angular.module("soWidget").filter("dayMonthFilter",a)}(),function(){angular.module("soCore",["pascalprecht.translate"])}(),function(){angular.module("soCore").constant("SHOUTOUT_HEIGHT","90").constant("EVENTS",{applyResize:"APPLY_RESIZE",resetShoutouts:"RESET_SHOUTOUTS",resizeFinish:"RESIZE_FINISH"}).constant("RESTApi",{url:"/api",ENV:"dev"}).config([function(){}])}(),function(){function a(a,b,c){function d(){return{generalBgColor:"generalBgColorOpacity",headerBgColor:"headerBgColorOpacity",fieldBgColor:"fieldBgColorOpacity",btnBgColor:"btnBgColorOpacity"}}function e(){function a(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[a[c]]=c);return b}return a(d())}function f(a){var b=d();for(var c in b)if(b.hasOwnProperty(c)){var e=a["design.opacity."+b[c]];$("#"+c).getCtrl().setOpacity(e)}}function g(a){var b={},c=["design.feed.lines.width","design.general.borderWidth","design.general.cornerRadius","design.header.alignment","design.opacity.btnBgColorOpacity","design.opacity.fieldBgColorOpacity","design.opacity.generalBgColorOpacity","design.opacity.headerBgColorOpacity","design.subscriptionForm.btnCornerRadius","design.subscriptionForm.fieldCornerRadius","settings.display.myLast","settings.display.publishedBefore","settings.display.state","settings.view.emailForm.checked","settings.view.header.checked","settings.email.confirmation.checked","userLanguage"];return _.forEach(c,function(c){b[c]=a[c]}),b.userLanguage=a["userLanguage.value"],b}function h(b){a(function(){$(function(){var a=g(c.flatten(b));Wix.UI.initialize(a),f(a),t("headerAlignBtns",a["design.header.alignment"]),t("LanguagePicker",a.userLanguage)})},50)}function i(){var a=b.defer();return Wix.Settings.getSiteInfo(function(b){if(!b)return a.reject();for(var c,d=b.referer.split("?")[1].split("&"),e={},f=0;f<d.length;f++)c=d[f].split("="),e[c[0]]=c[1];a.resolve(e)}),a.promise}function j(){return Wix.Utils.getDeviceType()}function k(){return Wix.Utils.getCompId()}function l(){function a(){var a={};return window.location.search.substr(1).split("&").forEach(function(b){b=b.split("="),a[b[0]]=b[1]}),a.compId}return Wix.Utils.getOrigCompId()||a()}function m(){var a={};return window.location.search.substr(1).split("&").forEach(function(b){b=b.split("="),a[b[0]]=b[1]}),a.instance||null}function n(){return Wix.Utils.getInstanceId()}function o(){return Wix.Utils.getLocale()}function p(){var a=b.defer();return Wix.Activities.getUserSessionToken(function(b){a.resolve(b)}),a.promise}function q(a){var b=e();return b[a]}function r(a){var b=d();return b[a]}function s(a){return $("#"+a).getCtrl().getValue().index}function t(a,b){$("#"+a).getCtrl().setValue(b)}function u(a){var b=$("#"+a).getCtrl().getValue();return 100*b.split(/[()]/)[1].split(",")[3]}function v(a,b){var c=$("#"+a).getCtrl(),d="#"+q(a);$(d).getCtrl().setOpacity(c.getValue()),$(d).getCtrl().colorChangedInInnerPlugins("opacity",b,c.getValue())}function w(a){Wix.Settings.getDashboardAppUrl(a)}return{init:h,getDeviceType:j,getCompId:k,getOrigCompId:l,getInstanceId:n,getSiteInfo:i,getLocationInstanceId:m,getLocale:o,getUserSession:p,getSpinner:r,getColorPicker:q,getComponentValue:s,setComponentValue:t,getPickerOpacity:u,setColorPickerOpacity:v,getDashboardAppUrl:w}}angular.module("soCore").factory("WixService",["$timeout","$q","JsonService",a])}(),function(){angular.module("soCore").service("JsonService",[function(){var a=function(a){function b(a,d){if(Object(a)!==a)c[d]=a;else if(Array.isArray(a)){for(var e=0,f=a.length;f>e;e++)b(a[e],d+"["+e+"]");0==f&&(c[d]=[])}else{var g=!0;for(var h in a)g=!1,b(a[h],d?d+"."+h:h);g&&d&&(c[d]={})}}var c={};return b(a,""),c},b=function(a){if(Object(a)!==a||Array.isArray(a))return a;var b=/\.?([^.\[\]]+)|\[(\d+)\]/g,c={};for(var d in a){for(var e,f=c,g="";e=b.exec(d);)f=f[g]||(f[g]=e[2]?[]:{}),g=e[2]||e[1];f[g]=a[d]}return c[""]||c};return{flatten:a,unflatten:b}}])}(),function(){function a(a,b){function c(){var a={};return window.location.search.substr(1).split("&").forEach(function(b){b=b.split("="),a[b[0]]=b[1]}),a}return{request:function(a){try{var b=c();a.headers["x-wix-comp-id"]=b.origCompId||b.compId,a.headers["x-wix-location-instance-id"]=b.instance}catch(d){}return a}}}angular.module("soCore").factory("RequestInterceptor",["WixService","RESTApi",a])}(),function(){function a(a,b,c,d){function e(a){if(!a)throw new ReferenceError(i+"config object must be provided");if(!angular.isObject(a))throw new TypeError(i+"oConfig's must be an object.");if(!a.method)throw new ReferenceError(i+"oConfig must have a method property.");if(!a.url)throw new ReferenceError(i+"oConfig must have a url property.")}function f(c){return e(c),c.url=b.url+c.url,a(c)}function g(){var a=d.getLocale();a.match(/en|de|es|fr|it|pl|pt|ru|ja|ko|tr|nl|sv|no|da/i)||(a="en");var b={method:"GET",url:"/settings?locale="+a};return f(b).then(function(a){return a.data})}function h(a){var b={method:"PUT",url:"/settings",data:a};return f(b)}var i="SettingsService : ";return{get:g,update:h}}angular.module("soCore").factory("SettingsService",["$http","RESTApi","JsonService","WixService",a])}(),function(){function a(a,b,c,d){function e(a){if(a)return a;var b=$("#header").height()||0,c=$("#subscriptionForm").height()||0,e=angular.element(window).height()-b-c;return Math.ceil(e/d)}function f(a){return a&&(l=1),l++}function g(){var a=angular.element(window).height()-(k+j);$("#noShoutOuts").css("height",a)}function h(d){var h=b.defer();return g(),a({method:"GET",url:c.url+"/shoutouts",params:{count:e(d.count),page:f(d.resetPaging)}}).then(function(a){return!a.data.payload.length||a.data.payload.length<=0?h.reject():h.resolve(a.data.payload)},function(a){return h.reject(a)}),h.promise}function i(){return a({method:"GET",url:c.url+"/shoutouts/count"})}var j=54,k=50,l=1;return{get:h,getCount:i}}angular.module("soCore").factory("ShoutOutService",["$http","$q","RESTApi","SHOUTOUT_HEIGHT",a])}();